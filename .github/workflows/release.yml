name: Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.0.0, v1.0.1 ç­‰ tag æ—¶è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º release

jobs:
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install frontend dependencies
        run: cd client && npm ci

      - name: Build frontend
        run: cd client && npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    needs: build-frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: go-server/go.sum

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Build Windows binary
        run: |
          cd go-server
          go build -ldflags="-s -w" -o ../look-alike.exe ./cmd/server
        env:
          CGO_ENABLED: 1
          GOOS: windows
          GOARCH: amd64

      - name: Create Windows package
        run: |
          mkdir -p look-alike-windows-x64
          cp look-alike.exe look-alike-windows-x64/
          cp -r dist look-alike-windows-x64/
          mkdir look-alike-windows-x64/db
          echo "Look-Alike Image Comparison Tool" > look-alike-windows-x64/README.txt
          echo "=================================" >> look-alike-windows-x64/README.txt
          echo "" >> look-alike-windows-x64/README.txt
          echo "Quick Start:" >> look-alike-windows-x64/README.txt
          echo "1. Double-click look-alike.exe" >> look-alike-windows-x64/README.txt
          echo "2. Open browser: http://localhost:4568" >> look-alike-windows-x64/README.txt
        shell: bash

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path look-alike-windows-x64 -DestinationPath look-alike-windows-x64.zip
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: look-alike-windows-x64.zip
          retention-days: 1

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: build-frontend
    strategy:
      matrix:
        include:
          - arch: amd64
            name: macos-x64
          - arch: arm64
            name: macos-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: go-server/go.sum

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: Build macOS binary
        run: |
          cd go-server
          GOOS=darwin GOARCH=${{ matrix.arch }} CGO_ENABLED=1 \
            go build -ldflags="-s -w" -o ../look-alike ./cmd/server

      - name: Create macOS package
        run: |
          mkdir -p look-alike-${{ matrix.name }}
          cp look-alike look-alike-${{ matrix.name }}/
          cp -r dist look-alike-${{ matrix.name }}/
          mkdir look-alike-${{ matrix.name }}/db

          cat > look-alike-${{ matrix.name }}/README.txt << EOF
          Look-Alike Image Comparison Tool
          =================================

          Platform: macOS ${{ matrix.arch }}

          Quick Start:
          -----------
          1. Open Terminal in this directory
          2. Run: ./look-alike
          3. Open browser: http://localhost:4568

          Note: First run may require security approval
          System Preferences > Security & Privacy > Allow

          Configuration:
          -------------
          - Default port: 4568
          - Change port: PORT=8080 ./look-alike

          Data:
          -----
          - Database: db/look_alike.sqlite3
          - Auto-created on first run
          EOF

      - name: Create tar.gz archive
        run: |
          tar -czf look-alike-${{ matrix.name }}.tar.gz look-alike-${{ matrix.name }}

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: look-alike-${{ matrix.name }}.tar.gz
          retention-days: 1

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display structure of downloaded files
        run: ls -R artifacts/

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Look-Alike v${{ steps.get_version.outputs.VERSION }}

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          æ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼š

          - **Windows ç”¨æˆ·**: `look-alike-windows-x64.zip`
          - **macOS Intel ç”¨æˆ·**: `look-alike-macos-x64.tar.gz`
          - **macOS Apple Silicon ç”¨æˆ·**: `look-alike-macos-arm64.tar.gz`

          ### ğŸš€ å¿«é€Ÿå¼€å§‹

          #### Windows
          1. è§£å‹ ZIP æ–‡ä»¶
          2. åŒå‡» `look-alike.exe`
          3. æµè§ˆå™¨è®¿é—® `http://localhost:4568`

          #### macOS
          1. è§£å‹ tar.gz æ–‡ä»¶
          2. ç»ˆç«¯è¿è¡Œ `./look-alike`
          3. æµè§ˆå™¨è®¿é—® `http://localhost:4568`

          é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œã€‚

          ### âœ¨ ä¸»è¦ç‰¹æ€§

          - ğŸ¯ é«˜æ€§èƒ½å›¾ç‰‡ç›¸ä¼¼åº¦æ¯”å¯¹ï¼ˆpHash + RGB é¢œè‰²ç›´æ–¹å›¾ï¼‰
          - ğŸš€ å¹¶å‘å¤„ç†ï¼ˆGo goroutinesï¼‰
          - ğŸ’¾ è‡ªåŠ¨æ•°æ®åº“åˆå§‹åŒ–ï¼ˆSQLiteï¼‰
          - ğŸ¨ ç°ä»£åŒ– Web ç•Œé¢ï¼ˆReact + Ant Designï¼‰
          - ğŸ“¦ å•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ— éœ€å®‰è£…ä¾èµ–ï¼‰

          ### ğŸ“ æ›´æ–°æ—¥å¿—

          æŸ¥çœ‹å®Œæ•´çš„æ›´æ–°æ—¥å¿—è¯·è®¿é—®é¡¹ç›®ä»“åº“ã€‚

          ### ğŸ› é—®é¢˜åé¦ˆ

          å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Look-Alike ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/windows-x64/look-alike-windows-x64.zip
            artifacts/macos-x64/look-alike-macos-x64.tar.gz
            artifacts/macos-arm64/look-alike-macos-arm64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
