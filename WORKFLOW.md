# Look-Alike 工作流程说明

## 核心原则

**在处理和比较阶段不移动文件，只在最后导出时才复制文件。**

## 工作流程

### 1. 扫描阶段（ScannerService）

**目的**: 索引源文件，读取属性

**操作**:
- 扫描源目录下的所有图片文件
- 读取每个图片的属性：
  - 文件完整路径（`full_path`）
  - 相对路径（`relative_path`）
  - 尺寸（`width`, `height`）
  - 文件大小（`size_bytes`）
- 将信息存储到 `source_files` 表

**重要**:
- ✅ 只读取文件属性
- ✅ 不移动文件
- ✅ 不复制文件
- ✅ 文件保持在原始位置

### 2. 比较阶段（ComparisonService）

**目的**: 比较源图片和目标图片，找出相似匹配

**操作**:
- 读取每个源文件
- 扫描所有目标目录的图片文件
- 对每个源文件与目标文件进行相似度比较
- 保存相似度 > 50% 的前10个匹配结果到 `comparison_candidates` 表
  - 候选项文件路径（`file_path`）
  - 相似度分数（`similarity_score`）
  - 排名（`rank`）
  - 尺寸（`width`, `height`）

**重要**:
- ✅ 只读取和比较图片
- ✅ 不移动文件
- ✅ 不复制文件
- ✅ 所有文件保持在原始位置

### 3. 用户确认阶段（Web界面）

**目的**: 用户手动确认匹配结果

**操作**:
- 用户在 Web 界面查看匹配结果
- 对于每个源文件，可以：
  - 查看所有候选项（每个目标最多10个）
  - 选择最佳匹配（可选）
  - 勾选"确认"标记
- 保存用户选择到 `selections` 表：
  - `confirmed`: 是否确认
  - `selected_candidate_id`: 用户选择的特定候选项ID（可选）

**重要**:
- ✅ 只更新数据库记录
- ✅ 不移动文件
- ✅ 不复制文件

### 4. 导出阶段（ExportService）

**目的**: 根据用户确认的结果，复制文件到输出目录

**操作**:
- 查询所有 `confirmed = true` 的选择
- 对于每个确认的源文件：
  - 如果用户指定了 `selected_candidate_id`，导出该特定候选项
  - 如果没有指定，导出每个目标的最佳匹配（rank=1）
- 复制文件到输出目录
  - 目录结构: `Output/[目标名称]/[源文件相对路径目录]`
  - 文件名: `[源文件名].[目标文件扩展名]`

**重要**:
- ⚠️ **这是唯一进行文件复制操作的阶段**
- ✅ 只复制已确认的匹配项
- ✅ 保持源文件目录结构
- ✅ 原始文件不受影响

## 数据库表说明

### source_files
存储源文件信息
- `full_path`: 文件完整路径
- `relative_path`: 相对路径
- `width`, `height`: 图片尺寸
- `status`: 处理状态

### comparison_candidates
存储匹配候选项
- `source_file_id`: 源文件ID
- `project_target_id`: 目标ID
- `file_path`: 候选项文件路径
- `similarity_score`: 相似度分数
- `rank`: 排名（1-10）

### selections
存储用户确认结果
- `source_file_id`: 源文件ID
- `confirmed`: 是否确认
- `selected_candidate_id`: 用户选择的候选项ID（可选）

## 输出目录结构示例

```
Output/
├── 目标1/
│   ├── folder1/
│   │   └── image1.jpg
│   └── folder2/
│       └── image2.png
└── 目标2/
    ├── folder1/
    │   └── image1.jpg
    └── folder2/
        └── image2.webp
```

## 总结

整个工作流程确保：
1. **扫描和比较阶段**：只读取文件，记录路径和属性到数据库
2. **用户确认阶段**：只更新数据库记录，不操作文件
3. **导出阶段**：才进行唯一的文件复制操作，根据数据库记录的路径复制已确认的文件

这样的设计：
- ✅ 避免不必要的文件操作
- ✅ 提高处理速度
- ✅ 不影响原始文件
- ✅ 用户有完全的控制权
